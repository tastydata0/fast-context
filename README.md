# fast-context üöÄ

**–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π –ø—Ä–æ–±—Ä–æ—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö) –º–µ–∂–¥—É –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏ –Ω–∞ Python.**

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ø–µ—Ä–µ–¥–∞—á–∏ —Å–∫–≤–æ–∑–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Ç–∞–∫–∏—Ö –∫–∞–∫ `request_id`, `user_id`, `trace_id`) —á–µ—Ä–µ–∑ –≤—Å—é —Ü–µ–ø–æ—á–∫—É –≤—ã–∑–æ–≤–æ–≤ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏—Ö —è–≤–Ω–æ –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.

–û–Ω–∞ —Å–≤—è–∑—ã–≤–∞–µ—Ç `ContextVars`, HTTP-–∫–ª–∏–µ–Ω—Ç `httpx`, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `loguru`) –∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ `FastAPI` –≤ –µ–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º.

```mermaid
graph LR
    %% –°—Ç–∏–ª–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
    classDef input fill:#f9f9f9,stroke:#333,stroke-dasharray: 5 5;
    classDef core fill:#e1f5fe,stroke:#0277bd,stroke-width:2px;
    classDef out fill:#fff3e0,stroke:#ef6c00,stroke-width:2px;

    %% –£–∑–ª—ã
    Req(–í—Ö–æ–¥—è—â–∏–π HTTP):::input -->|X-App-Trace-Id| Mid[Middleware]:::core
    
    subgraph Service [–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å]
        direction TB
        Mid -->|–ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –≤<br/>trace_id| Ctx((ContextVars)):::core
        Ctx -.->|–ê–≤—Ç–æ-–ø—Ä–æ–±—Ä–æ—Å| Log[Loguru]:::core
        Ctx -->|–ê–≤—Ç–æ-–ø—Ä–æ–±—Ä–æ—Å| Client[Httpx Client]:::core
    end
    
    Client -->|X-Out-Trace-Id| Ext(–í–Ω–µ—à–Ω–∏–π API):::out

    %% –°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç–∏–ª—å –¥–ª—è Service (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    style Service fill:#ffffff,stroke:#999,stroke-width:1px
```

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

*   **Zero-boilerplate:** –ù–µ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å —Å–∏–≥–Ω–∞—Ç—É—Ä—ã —Ñ—É–Ω–∫—Ü–∏–π.
*   **Async-safe:** –ü–æ—Å—Ç—Ä–æ–µ–Ω–æ –Ω–∞ –Ω–∞—Ç–∏–≤–Ω—ã—Ö `contextvars` ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∫–∞–∂–¥–æ–π Task (–∑–∞–ø—Ä–æ—Å–∞).
*   **HTTPX Integration:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Ö–µ–¥–µ—Ä–æ–≤ –≤–æ –≤—Å–µ –∏—Å—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞ `httpx`.
*   **FastAPI Middleware:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ö–µ–¥–µ—Ä–æ–≤ –∏–∑ –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–º–µ—â–µ–Ω–∏–µ –∏—Ö –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
*   **Aggregator:** –£–¥–æ–±–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å –ª–æ–≥–≥–µ—Ä–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, `loguru`) –∏ HTTP-–∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
*   **Smart Naming:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è `X-Header-Case` ‚Üî `snake_case`.

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

–ü–æ—Å–∫–æ–ª—å–∫—É –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ –≤ PyPI, –µ—ë –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è GitHub.

### –ß–µ—Ä–µ–∑ pip

```bash
pip install git+https://github.com/tastydata0/fast-context.git
```

### –ß–µ—Ä–µ–∑ uv

1. –í —Å–µ–∫—Ü–∏—é `dependencies` –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞:

```toml
[project]
dependencies = [
    "fast-context",
]
```

2. –í —Å–µ–∫—Ü–∏—é `[tool.uv.sources]` —É–∫–∞–∂–∏—Ç–µ, –æ—Ç–∫—É–¥–∞ –µ–≥–æ –±—Ä–∞—Ç—å:

```toml
[tool.uv.sources]
fast-context = { git = "https://github.com/tastydata0/fast-context.git", branch = "main" }
```

> –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –≤–º–µ—Å—Ç–æ `branch = "main"` –ª—É—á—à–µ —É–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ–≥ (`tag = "v0.1.0"`) –∏–ª–∏ —Ö–µ—à –∫–æ–º–º–∏—Ç–∞ (`rev = "a1b2c3d"`), —á—Ç–æ–±—ã –∫–æ–¥ –≤–Ω–µ–∑–∞–ø–Ω–æ –Ω–µ –ø–æ–º–µ–Ω—è–ª—Å—è.

---

## üõ† –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1.  **–í—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å:** Middleware –ª–æ–≤–∏—Ç —Ö–µ–¥–µ—Ä—ã —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –ø—Ä–µ—Ñ–∏–∫—Å–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, `X-App-Request-ID`) –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–∞–∫ `request_id`.
2.  **–í–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:** –õ–æ–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä).
3.  **–ò—Å—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å:** –ü—Ä–æ–ø–∞—Ç—á–µ–Ω–Ω—ã–π `httpx` –∫–ª–∏–µ–Ω—Ç —á–∏—Ç–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç `request_id` –æ–±—Ä–∞—Ç–Ω–æ –≤ `X-Context-Request-ID` (–ø—Ä–µ—Ñ–∏–∫—Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –¥–∞–ª—å—à–µ.

---

## üìñ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

–ó–¥–µ—Å—å –º—ã —Å–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é –∏ –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∞–º–∞ –ø—Ä–æ–∫–∏–Ω–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ö–µ–¥–µ—Ä—ã.

```python
import httpx
from fast_context import ContextVarsManager, ContextManagerAggregator
from loguru import logger

# 1. –ú–µ–Ω–µ–¥–∂–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Ö—Ä–∞–Ω–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ø–æ–≤–µ—Ä—Ö contextvars)
manager = ContextVarsManager()

# 2. –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä. –û–Ω –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –æ–¥–Ω–æ–π —Å—Ç—Ä–æ—á–∫–æ–π –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç 
# –∏ –¥–ª—è HTTP-–∫–ª–∏–µ–Ω—Ç–∞, –∏ –¥–ª—è –õ–æ–≥–≥–µ—Ä–∞ (loguru).
# (–õ—é–±–æ–π –æ–±—ä–µ–∫—Ç —Å –º–µ—Ç–æ–¥–æ–º contextualize(**kwargs) –ø–æ–¥–æ–π–¥–µ—Ç)
ctx = ContextManagerAggregator(manager, logger)

# 3. –°–æ–∑–¥–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π httpx –∫–ª–∏–µ–Ω—Ç
http_client = httpx.AsyncClient()

# 4. "–ú–∞–≥–∏—è": –ü–∞—Ç—á–∏–º –∫–ª–∏–µ–Ω—Ç.
# –¢–µ–ø–µ—Ä—å –æ–Ω –±—É–¥–µ—Ç —Å–º–æ—Ç—Ä–µ—Ç—å –≤ manager –∏ –¥–æ–±–∞–≤–ª—è—Ç—å —Ö–µ–¥–µ—Ä—ã —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º "x-app-"
manager.inject_to_client(http_client, prefix="x-app-")

async def main():
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º request_id –∏ user_id.
    # –û–Ω–∏ –ø–æ–ø–∞–¥—É—Ç –∏ –≤ –ª–æ–≥–∏, –∏ –≤ –∏—Å—Ö–æ–¥—è—â–∏–µ —Ö–µ–¥–µ—Ä—ã.
    with ctx.contextualize(request_id="req-123", user_id="user-1"):
        logger.info("Doing work...") 
        
        # –ò—Å—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–µ–¥–µ—Ä—ã:
        # x-app-request-id: req-123
        # x-app-user-id: user-1
        await http_client.get("http://localhost:8000/")

        # –í–ª–æ–∂–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–º–µ—Ä–∂–∏—Ç—Å—è —Å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º)
        with ctx.contextualize(trace_id="trace-999"):
            # –•–µ–¥–µ—Ä—ã –∑–¥–µ—Å—å: request-id, user-id –ò trace-id
            await http_client.get("http://localhost:8000/nested")

    # –ó–¥–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —á–∏—Å—Ç
    await http_client.get("http://localhost:8000/clean")
```

### 2. –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å: FastAPI Middleware

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞—Ö–≤–∞—Ç —Ö–µ–¥–µ—Ä–æ–≤ –∏–∑ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

```python
import uvicorn
import httpx
from fastapi import FastAPI
from loguru import logger

from fast_context import (
    ContextManagerAggregator, 
    ContextVarsManager, 
    HeaderToContextMiddleware
)

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (Singleton) ---

ctx_manager = ContextVarsManager()
# –û–±—ä–µ–¥–∏–Ω—è–µ–º –ª–æ–≥–≥–µ—Ä –∏ –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
ctx = ContextManagerAggregator(logger, ctx_manager)

# –ö–ª–∏–µ–Ω—Ç –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –¥—Ä—É–≥–∏–º –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º
http_client = httpx.AsyncClient()
# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –≤—Ö–æ–¥—è—â–µ–≥–æ)
ctx_manager.inject_to_client(http_client, prefix="X-Internal-")

app = FastAPI()

# --- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Middleware ---

app.add_middleware(
    HeaderToContextMiddleware,
    context_manager=ctx,     # –ö—É–¥–∞ —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    header_prefix="X-App-",  # –ö–∞–∫–∏–µ —Ö–µ–¥–µ—Ä—ã –∏—Å–∫–∞—Ç—å –≤–æ –≤—Ö–æ–¥—è—â–µ–º –∑–∞–ø—Ä–æ—Å–µ
)

@app.get("/")
async def proxy_endpoint():
    """
    –°—Ü–µ–Ω–∞—Ä–∏–π:
    1. –ü—Ä–∏—à–µ–ª –∑–∞–ø—Ä–æ—Å —Å —Ö–µ–¥–µ—Ä–æ–º: X-App-Trace-Id: abc-123
    2. Middleware –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª–∞ –µ–≥–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é trace_id="abc-123"
    3. Loguru (—á–µ—Ä–µ–∑ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä) –ø–æ–ª—É—á–∏–ª trace_id.
    4. ContextVarsManager –ø–æ–ª—É—á–∏–ª trace_id.
    """
    
    # –í –ª–æ–≥–∞—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è {trace_id}
    logger.info("Processing request inside endpoint")

    # Httpx –∫–ª–∏–µ–Ω—Ç –¥–æ—Å—Ç–∞–Ω–µ—Ç trace_id, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ Kebab-Case,
    # –¥–æ–±–∞–≤–∏—Ç –ø—Ä–µ—Ñ–∏–∫—Å 'X-Internal-' –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç.
    # –ò—Ç–æ–≥–æ–≤—ã–π —Ö–µ–¥–µ—Ä –∏—Å—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: X-Internal-Trace-Id: abc-123
    await http_client.get("https://another-service.local/data")

    return {"status": "ok"}
```

### –ò–Ω—ä–µ–∫—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∫–∞—á–µ—Å—Ç–≤–µ kwargs

```python
manager = ContextVarsManager()

@manager.inject_kwargs("bar")
def foo(**kwargs):
    print(kwargs)


@manager.inject_kwargs("bar", override=True)
def foo2(**kwargs):
    print(kwargs)


with manager.contextualize(bar=123, baz="test"):
    foo()  # {'bar': 123}
    foo2()  # {'bar': 123}

    foo(bar=-1)  # {'bar': -1}
    foo2(bar=-1)  # {'bar': 123}
```

## ‚öôÔ∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Å –∫–ª—é—á–∞–º–∏

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–µ–π –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º Python –∏ HTTP:

*   **HTTP Headers (Kebab-Case):** `X-App-User-Id`
*   **Python Context (Snake_Case):** `user_id`

–ö–æ–≥–¥–∞ Middleware —á–∏—Ç–∞–µ—Ç —Ö–µ–¥–µ—Ä `X-App-User-Id`, –æ–Ω–∞ –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å –∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç `User-Id` –≤ `user_id`.
–ö–æ–≥–¥–∞ HTTP Client –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `user_id`, –æ–Ω –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –µ—ë –æ–±—Ä–∞—Ç–Ω–æ –≤ `User-Id` –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å.
